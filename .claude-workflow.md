# Mandatory Workflow

## Step 1: STOP AND READ
- What is the ACTUAL error message?
- What file is causing it?
- What does that file's code actually say?

## Step 2: INVESTIGATE
- Read the relevant route file
- Read the relevant frontend code
- Check for field name mismatches
- Check the Prisma schema

## Step 3: VERIFY BEFORE CODING
- Will this fix actually work?
- Are there other places with the same issue?
- What could break from this change?

## Step 4: TEST AFTER CODING
- Does the server start without errors?
- Does the API call return 200?
- Does the UI actually work?
- Check the browser console

## Step 5: DOCUMENT
- Update this file with what was learned
- Add the mistake to the "common mistakes" list

## Common Mistakes Log

### Field Name Mismatches
- **Mistake**: Frontend sent `name` field, API expected `title` field
- **Fix**: Updated API to accept both `title` and `name` for backward compatibility
- **Location**: `/src/app/api/tasks/patients/[id]/tasks/route.ts:64`
- **Lesson**: Always check both frontend and backend for field name consistency

### Database Connection Issues
- **Mistake**: Using Railway internal URL locally causes TLS errors
- **Fix**: Use public Railway URL for local dev: `shinkansen.proxy.rlwy.net:40506`
- **Location**: `.env.local`
- **Lesson**: Railway internal URLs only work on Railway servers

### Patient Data Structure Changes
- **Mistake**: Accessing `patient.name` when structure changed to `patient.demographics.name`
- **Fix**: Use fallback pattern: `patient.demographics?.name || patient.name || 'Unnamed'`
- **Location**: Multiple locations in `/src/app/page.tsx`
- **Lesson**: When data structure changes, use defensive fallback patterns

### Adding Fields Without Database Migration (CRITICAL)
- **Date**: 2025-01-16
- **Mistake**: Added `patient.type` field references in API code BEFORE adding column to database
- **Result**: ALL patient creation failed with 500 errors, causing severe data integrity issues
- **Impact**: User couldn't create patients, duplicates appeared, complete workflow breakdown
- **Fix**: Made field nullable temporarily, then ran migration
- **Location**: `prisma/schema.prisma`, `/src/app/api/patients/*/route.ts`
- **Lesson**: **NEVER EVER add field references in code before database migration**

**MANDATORY PROCESS for adding new database fields:**
1. ✅ FIRST: Add field to Prisma schema
2. ✅ SECOND: Create migration (`npx prisma migrate dev`)
3. ✅ THIRD: Run migration on production database
4. ✅ FOURTH: Regenerate Prisma client
5. ✅ FIFTH: ONLY THEN add field references in API code
6. ✅ SIXTH: Test thoroughly before committing

**WARNING SIGNS you're doing it wrong:**
- TypeScript errors: "Property 'xyz' does not exist on type..."
- 500 errors when creating/updating records
- Prisma errors about missing columns
- **STOP IMMEDIATELY if you see these - you skipped the migration step**
