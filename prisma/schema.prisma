// VetHub 2.0 Database Schema
// UnifiedPatient data model with support for SOAP notes, rounding, MRI, tasks, stickers

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main patient model
model Patient {
  id     Int      @id @default(autoincrement())
  status String   // Active | Discharged
  type   String?  @default("Medical") // Medical | MRI | Surgery (nullable until migration runs)

  // Demographics (JSON field)
  demographics Json

  // Medical history (JSON field)
  medicalHistory Json @default("{}")

  // Current hospitalization (JSON field, nullable)
  currentStay Json?

  // Rounding data (JSON field, nullable)
  roundingData Json?

  // MRI data (JSON field, nullable)
  mriData Json?

  // Sticker data (JSON field, nullable)
  stickerData Json?

  // Appointment info (JSON field, nullable)
  appointmentInfo Json?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastAccessedBy  String?

  // Relations
  soapNotes       SOAPNote[]
  tasks           Task[]
  neuroExams      NeuroExam[]
  resiliencyEntries ResiliencyEntry[]

  @@index([status])
  @@index([createdAt])
}

// SOAP Note model
model SOAPNote {
  id          String   @id @default(cuid())
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  createdBy   String?
  visitType   String   // recheck | initial

  // Subjective (JSON field)
  subjective  Json     @default("{}")

  // Objective - Physical Exam (JSON field)
  physicalExam Json?

  // Objective - Neuro Exam (JSON field)
  neuroExam    Json?

  // Assessment (JSON field)
  assessment   Json?

  // Plan (JSON field)
  plan         Json?

  @@index([patientId])
  @@index([createdAt])
}

// Task model
model Task {
  id          String    @id @default(cuid())
  patientId   Int?
  patient     Patient?  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  title       String
  description String?
  category    String?
  timeOfDay   String?   // morning | evening | overnight | anytime
  priority    String?   // low | medium | high | urgent
  assignedTo  String?

  completed   Boolean   @default(false)
  completedAt DateTime?
  completedDate String?  // Date string (YYYY-MM-DD) for daily task tracking
  createdAt   DateTime  @default(now())
  dueDate     DateTime?

  @@index([patientId])
  @@index([completed])
  @@index([createdAt])
  @@index([completedDate])
}

// Common items for auto-complete
model CommonProblem {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model CommonComment {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model CommonMedication {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

// Appointment Schedule model
model Appointment {
  id               String    @id @default(cuid())
  sortOrder        Int       // For custom drag-and-drop ordering
  date             String    // Date of appointment (YYYY-MM-DD format)

  // Core Information
  patientName      String
  appointmentTime  String?
  age              String?
  status           String    @default("recheck") // new | recheck | mri-dropoff

  // Clinical Data
  whyHereToday     String?
  lastVisit        String?
  mri              String?
  bloodwork        String?
  medications      String?
  changesSinceLastVisit String?
  otherNotes       String?

  // Visual Markers
  highlight        String?   @default("none") // none | yellow | red | green - whiteboard-style highlighting

  // Metadata
  rawText          String?   // Original pasted text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([date])
  @@index([appointmentTime])
}

// Smart Auto-Complete Phrases
// Learns from user's past rounding sheets and SOAP notes
model CommonPhrase {
  id          String   @id @default(cuid())
  field       String   // problems | diagnostics | therapeutics | concerns
  phrase      String
  usageCount  Int      @default(1)
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  @@index([field])
  @@index([usageCount])
  @@unique([field, phrase])
}

// Neuro Exam model - Comprehensive neurological examination
model NeuroExam {
  id          String    @id @default(cuid())
  patientId   Int?      // Optional - can be standalone or linked to patient
  patient     Patient?  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Exam sections data (JSON field)
  // Each section contains: status (normal/abnormal), expanded (boolean), data (findings)
  sections    Json      @default("{}")

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Who performed the exam

  @@index([patientId])
  @@index([createdAt])
}

// Resiliency Logger - Track patient resilience entries
model ResiliencyEntry {
  id          String    @id @default(cuid())
  patientId   Int
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Entry content
  entryText   String    @db.Text
  category    String?   // behavioral | physical | emotional | social

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Who logged the entry

  @@index([patientId])
  @@index([createdAt])
  @@index([category])
}

// Quick Insert Options for Rounding Sheet
// Synced server-side so options persist across devices/users
model QuickInsertOption {
  id        String   @id @default(cuid())
  label     String   // Button display text
  text      String   // Text inserted into field
  category  String   // 'surgery' | 'seizures' | 'other'
  field     String   // 'therapeutics' | 'diagnostics' | 'concerns' | 'problems'
  isDefault Boolean  @default(false) // true = system default, false = user-added
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([field])
}

// Problem Options for Rounding Sheet Problems column
// Synced server-side so options persist across devices/users
model ProblemOption {
  id        String   @id @default(cuid())
  label     String   @unique // Problem name (e.g., "Cervical myelopathy")
  isDefault Boolean  @default(false) // true = system default, false = user-added
  createdAt DateTime @default(now())

  @@index([isDefault])
}

// App-wide settings stored in database (not localStorage)
// Used for global state that should persist across all browsers/devices
model AppSetting {
  id        String   @id @default("app_settings")
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@index([key])
}

// Quick Reference Medications - persisted across all devices
model ReferenceMedication {
  id        String   @id @default(cuid())
  name      String   @unique
  dose      String
  notes     String?
  isDefault Boolean  @default(false) // true = system default, false = user-added
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

// Quick Reference Protocols - persisted across all devices
model ReferenceProtocol {
  id        String   @id @default(cuid())
  name      String   @unique
  content   String   @db.Text // Protocol steps/content
  isDefault Boolean  @default(false) // true = system default, false = user-added
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

// Learning Notes - Questions to clarify (e.g., with Glass)
model Note {
  id        String   @id @default(cuid())
  content   String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([completed])
  @@index([createdAt])
}

// ==========================================
// ACVIM Neurology Residency Tracking Models
// Matches official ACVIM Credentials Committee forms exactly
// ==========================================

// Resident Profile - identity and program settings
model ACVIMProfile {
  id                        String   @id @default(cuid())
  residentName              String
  acvimCandidateId          String?
  trainingFacility          String?
  programStartDate          String?  // ISO date - when residency started (e.g., "2025-07-14")
  programEndDate            String?  // ISO date - explicit end date (e.g., "2028-07-15") - overrides 3-year calc
  supervisingDiplomateNames String[] // Default diplomates for quick fill
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// Neurosurgery Case Log - ACVIM form exact match
// Columns: Procedure Name, Date Completed, Case ID Number, Primary or Assistant, Hours
model ACVIMNeurosurgeryCase {
  id            String   @id @default(cuid())
  procedureName String   // Free text: "hemilaminectomy", "ventral slot", etc.
  dateCompleted String   // ISO date (YYYY-MM-DD)
  caseIdNumber  String   // Medical record / patient ID number
  role          String   // "Primary" | "Assistant" (per ACVIM instructions)
  hours         Float    // 0.25 increments (15-min blocks)
  residencyYear Int      // 1, 2, or 3
  notes         String?

  // Optional link to VetHub patient
  patientId     Int?
  patientName   String?
  patientInfo   String?  // Species/breed for reference

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([residencyYear])
  @@index([dateCompleted])
}

// Journal Club Log - ACVIM form exact match
// Columns: Date, Title of Article(s), Supervising Neurologist(s), Hours
model ACVIMJournalClub {
  id                      String   @id @default(cuid())
  date                    String   // ISO date (YYYY-MM-DD)
  articleTitles           String[] // Can have multiple articles per session
  supervisingNeurologists String[] // Board-certified neurologists in attendance
  hours                   Float    // 0.5 increments (30-min blocks)
  residencyYear           Int      // 1, 2, or 3
  notes                   String?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([residencyYear])
  @@index([date])
}

// Weekly Schedule Entry - ACVIM form exact match
// Pre-generated for all 52 weeks per year, user fills in hours
model ACVIMWeeklySchedule {
  id                        String   @id @default(cuid())
  residencyYear             Int      // 1, 2, or 3
  monthNumber               Int      // 1-12 (relative to residency start)
  weekNumber                Int      // 1-5 (week within month)
  weekDateRange             String   // Display format: "7/14-7/18"
  weekStartDate             String   // ISO date for sorting

  // ACVIM columns exactly as specified
  clinicalNeurologyDirect   Float?   // Weeks (0, 0.5, 1)
  clinicalNeurologyIndirect Float?   // Weeks (0, 0.5, 1)
  neurosurgeryHours         Float?   // 0.25, 0.5, 0.75, 1, etc.
  radiologyHours            Float?   // Whole hours only (1, 2, 3...)
  neuropathologyHours       Float?   // Whole hours only
  clinicalPathologyHours    Float?   // Whole hours only
  electrodiagnosticsHours   Float?   // 0.25, 0.5, 0.75, 1, etc.
  journalClubHours          Float?   // 0.5, 1, 1.5, etc.
  otherTime                 String?  // Free text for weeks/days
  otherTimeDescription      String?  // e.g., "vacation", "research", "Brain Camp"

  supervisingDiplomateName  String?  // REQUIRED per ACVIM but nullable for pre-generation

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([residencyYear, monthNumber, weekNumber])
  @@index([residencyYear])
  @@index([monthNumber])
}

// ==========================================
// Residency Stats Tracker & Gamification
// ==========================================

// Daily Entry - tracks MRIs, appointments, and surgeries for a single day
model DailyEntry {
  id            String   @id @default(cuid())
  date          String   @unique // ISO date (YYYY-MM-DD) - one entry per day

  // MRI counts
  mriCount      Int      @default(0)

  // Appointment counts by type
  recheckCount    Int      @default(0)  // Follow-up appointments
  newConsultCount Int      @default(0)  // First-time consultations
  emergencyCount  Int      @default(0)  // Emergency cases

  // Legacy field (kept for backward compatibility, = newConsultCount)
  newCount      Int      @default(0)

  // Communications count (emails, EzyVet notes, etc.)
  commsCount    Int      @default(0)

  // Shift tracking (clock in/out times in ISO format)
  shiftStartTime  String?  // e.g., "08:30" or ISO datetime
  shiftEndTime    String?  // e.g., "17:45" or ISO datetime

  // Calculated totals (denormalized for quick queries)
  totalCases    Int      @default(0) // mri + all appointments

  // Notes for the day
  notes         String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  surgeries     Surgery[]
  lmriEntries   LMRIEntry[]

  @@index([date])
}

// Surgery - individual surgery with participation level
// S = Surgeon (primary), O = Observer, C = Circulator, D = Dissector, K = Knife (cutting/suturing assistant)
model Surgery {
  id              String     @id @default(cuid())
  dailyEntryId    String
  dailyEntry      DailyEntry @relation(fields: [dailyEntryId], references: [id], onDelete: Cascade)

  procedureName   String     // e.g., "hemilaminectomy", "ventral slot", "craniotomy"
  participation   String     // "S" | "O" | "C" | "D" | "K"

  // Optional details
  patientName     String?
  notes           String?

  createdAt       DateTime   @default(now())

  @@index([dailyEntryId])
  @@index([participation])
}

// LMRI+ Entry - tracks neuro exam localization accuracy vs MRI findings
// L = Localized correctly, M = Missed (wrong localization), R = Right side correct
// I = Incorrect side, + = bonus (caught subtle finding)
model LMRIEntry {
  id              String     @id @default(cuid())
  dailyEntryId    String
  dailyEntry      DailyEntry @relation(fields: [dailyEntryId], references: [id], onDelete: Cascade)

  // Pre-MRI prediction
  predictedLocalization String  // e.g., "C2-C5 myelopathy", "L4-S3 LMN"
  predictedLaterality   String? // "Left" | "Right" | "Bilateral" | "Midline"

  // Post-MRI actual findings
  actualLocalization    String  // What MRI showed
  actualLaterality      String? // Actual side affected

  // Scoring
  localizationCorrect   Boolean // Was the spinal segment/region correct?
  lateralityCorrect     Boolean? // Was the side correct? (null if N/A)
  bonusFind             Boolean @default(false) // Caught something subtle

  // Patient reference (optional)
  patientName           String?
  notes                 String?

  createdAt             DateTime @default(now())

  @@index([dailyEntryId])
}

// Milestone - tracks when user hits case count milestones
model Milestone {
  id          String   @id @default(cuid())
  type        String   // "mri" | "appointment" | "surgery" | "case"
  count       Int      // The milestone number (50, 100, 150, etc.)
  achievedAt  DateTime @default(now())

  // Celebration tracking
  celebrated  Boolean  @default(false) // Has user seen the celebration?

  @@unique([type, count])
  @@index([type])
}

// Badge - gamification achievements
model Badge {
  id          String   @id @default(cuid())
  badgeId     String   @unique // e.g., "first_surgery", "mri_century", "streak_7"
  name        String   // Display name
  description String   // How it was earned
  icon        String?  // Emoji or icon identifier
  earnedAt    DateTime @default(now())

  // Celebration tracking
  celebrated  Boolean  @default(false)

  @@index([earnedAt])
}

// BingoCard - weekly rotating or permanent rare diagnosis cards
model BingoCard {
  id          String        @id @default(cuid())
  type        String        // "weekly" | "rare"
  weekStart   String?       // ISO date for weekly cards (null for rare)
  createdAt   DateTime      @default(now())
  completedAt DateTime?     // When all squares were completed

  squares     BingoSquare[]

  @@index([type])
  @@index([weekStart])
}

// BingoSquare - individual square on a bingo card
model BingoSquare {
  id          String    @id @default(cuid())
  cardId      String
  card        BingoCard @relation(fields: [cardId], references: [id], onDelete: Cascade)

  position    Int       // 0-24 for 5x5 grid
  text        String    // The bingo item text
  completed   Boolean   @default(false)
  completedAt DateTime?

  @@index([cardId])
}
