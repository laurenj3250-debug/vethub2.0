// VetHub 2.0 Database Schema
// UnifiedPatient data model with support for SOAP notes, rounding, MRI, tasks, stickers

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Main patient model
model Patient {
  id     Int      @id @default(autoincrement())
  status String   // Active | Discharged
  type   String?  @default("Medical") // Medical | MRI | Surgery (nullable until migration runs)

  // Demographics (JSON field)
  demographics Json

  // Medical history (JSON field)
  medicalHistory Json @default("{}")

  // Current hospitalization (JSON field, nullable)
  currentStay Json?

  // Rounding data (JSON field, nullable)
  roundingData Json?

  // MRI data (JSON field, nullable)
  mriData Json?

  // Sticker data (JSON field, nullable)
  stickerData Json?

  // Appointment info (JSON field, nullable)
  appointmentInfo Json?

  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastAccessedBy  String?

  // Relations
  soapNotes       SOAPNote[]
  tasks           Task[]
  neuroExams      NeuroExam[]
  resiliencyEntries ResiliencyEntry[]

  @@index([status])
  @@index([createdAt])
}

// SOAP Note model
model SOAPNote {
  id          String   @id @default(cuid())
  patientId   Int
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  createdBy   String?
  visitType   String   // recheck | initial

  // Subjective (JSON field)
  subjective  Json     @default("{}")

  // Objective - Physical Exam (JSON field)
  physicalExam Json?

  // Objective - Neuro Exam (JSON field)
  neuroExam    Json?

  // Assessment (JSON field)
  assessment   Json?

  // Plan (JSON field)
  plan         Json?

  @@index([patientId])
  @@index([createdAt])
}

// Task model
model Task {
  id          String    @id @default(cuid())
  patientId   Int?
  patient     Patient?  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  title       String
  description String?
  category    String?
  timeOfDay   String?   // morning | evening | overnight | anytime
  priority    String?   // low | medium | high | urgent
  assignedTo  String?

  completed   Boolean   @default(false)
  completedAt DateTime?
  completedDate String?  // Date string (YYYY-MM-DD) for daily task tracking
  createdAt   DateTime  @default(now())
  dueDate     DateTime?

  @@index([patientId])
  @@index([completed])
  @@index([createdAt])
  @@index([completedDate])
}

// Common items for auto-complete
model CommonProblem {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model CommonComment {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

model CommonMedication {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
}

// Appointment Schedule model
model Appointment {
  id               String    @id @default(cuid())
  sortOrder        Int       // For custom drag-and-drop ordering
  date             String    // Date of appointment (YYYY-MM-DD format)

  // Core Information
  patientName      String
  appointmentTime  String?
  age              String?
  status           String    @default("recheck") // new | recheck | mri-dropoff

  // Clinical Data
  whyHereToday     String?
  lastVisit        String?
  mri              String?
  bloodwork        String?
  medications      String?
  changesSinceLastVisit String?
  otherNotes       String?

  // Visual Markers
  highlight        String?   @default("none") // none | yellow | red | green - whiteboard-style highlighting

  // Metadata
  rawText          String?   // Original pasted text
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([date])
  @@index([appointmentTime])
}

// Smart Auto-Complete Phrases
// Learns from user's past rounding sheets and SOAP notes
model CommonPhrase {
  id          String   @id @default(cuid())
  field       String   // problems | diagnostics | therapeutics | concerns
  phrase      String
  usageCount  Int      @default(1)
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime @default(now())

  @@index([field])
  @@index([usageCount])
  @@unique([field, phrase])
}

// Neuro Exam model - Comprehensive neurological examination
model NeuroExam {
  id          String    @id @default(cuid())
  patientId   Int?      // Optional - can be standalone or linked to patient
  patient     Patient?  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Exam sections data (JSON field)
  // Each section contains: status (normal/abnormal), expanded (boolean), data (findings)
  sections    Json      @default("{}")

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Who performed the exam

  @@index([patientId])
  @@index([createdAt])
}

// Resiliency Logger - Track patient resilience entries
model ResiliencyEntry {
  id          String    @id @default(cuid())
  patientId   Int
  patient     Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)

  // Entry content
  entryText   String    @db.Text
  category    String?   // behavioral | physical | emotional | social

  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?   // Who logged the entry

  @@index([patientId])
  @@index([createdAt])
  @@index([category])
}

// Quick Insert Options for Rounding Sheet
// Synced server-side so options persist across devices/users
model QuickInsertOption {
  id        String   @id @default(cuid())
  label     String   // Button display text
  text      String   // Text inserted into field
  category  String   // 'surgery' | 'seizures' | 'other'
  field     String   // 'therapeutics' | 'diagnostics' | 'concerns' | 'problems'
  isDefault Boolean  @default(false) // true = system default, false = user-added
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([field])
}

// Problem Options for Rounding Sheet Problems column
// Synced server-side so options persist across devices/users
model ProblemOption {
  id        String   @id @default(cuid())
  label     String   @unique // Problem name (e.g., "Cervical myelopathy")
  isDefault Boolean  @default(false) // true = system default, false = user-added
  createdAt DateTime @default(now())

  @@index([isDefault])
}

// ==========================================
// ACVIM Neurology Residency Tracking Models
// Matches official ACVIM Credentials Committee forms exactly
// ==========================================

// Resident Profile - identity and program settings
model ACVIMProfile {
  id                        String   @id @default(cuid())
  residentName              String
  acvimCandidateId          String?
  trainingFacility          String?
  programStartDate          String?  // ISO date - when residency started (e.g., "2025-07-14")
  supervisingDiplomateNames String[] // Default diplomates for quick fill
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// Neurosurgery Case Log - ACVIM form exact match
// Columns: Procedure Name, Date Completed, Case ID Number, Primary or Assistant, Hours
model ACVIMNeurosurgeryCase {
  id            String   @id @default(cuid())
  procedureName String   // Free text: "hemilaminectomy", "ventral slot", etc.
  dateCompleted String   // ISO date (YYYY-MM-DD)
  caseIdNumber  String   // Medical record / patient ID number
  role          String   // "Primary" | "Assistant" (per ACVIM instructions)
  hours         Float    // 0.25 increments (15-min blocks)
  residencyYear Int      // 1, 2, or 3
  notes         String?

  // Optional link to VetHub patient
  patientId     Int?
  patientName   String?
  patientInfo   String?  // Species/breed for reference

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([residencyYear])
  @@index([dateCompleted])
}

// Journal Club Log - ACVIM form exact match
// Columns: Date, Title of Article(s), Supervising Neurologist(s), Hours
model ACVIMJournalClub {
  id                      String   @id @default(cuid())
  date                    String   // ISO date (YYYY-MM-DD)
  articleTitles           String[] // Can have multiple articles per session
  supervisingNeurologists String[] // Board-certified neurologists in attendance
  hours                   Float    // 0.5 increments (30-min blocks)
  residencyYear           Int      // 1, 2, or 3
  notes                   String?

  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([residencyYear])
  @@index([date])
}

// Weekly Schedule Entry - ACVIM form exact match
// Pre-generated for all 52 weeks per year, user fills in hours
model ACVIMWeeklySchedule {
  id                        String   @id @default(cuid())
  residencyYear             Int      // 1, 2, or 3
  monthNumber               Int      // 1-12 (relative to residency start)
  weekNumber                Int      // 1-5 (week within month)
  weekDateRange             String   // Display format: "7/14-7/18"
  weekStartDate             String   // ISO date for sorting

  // ACVIM columns exactly as specified
  clinicalNeurologyDirect   Float?   // Weeks (0, 0.5, 1)
  clinicalNeurologyIndirect Float?   // Weeks (0, 0.5, 1)
  neurosurgeryHours         Float?   // 0.25, 0.5, 0.75, 1, etc.
  radiologyHours            Float?   // Whole hours only (1, 2, 3...)
  neuropathologyHours       Float?   // Whole hours only
  clinicalPathologyHours    Float?   // Whole hours only
  electrodiagnosticsHours   Float?   // 0.25, 0.5, 0.75, 1, etc.
  journalClubHours          Float?   // 0.5, 1, 1.5, etc.
  otherTime                 String?  // Free text for weeks/days
  otherTimeDescription      String?  // e.g., "vacation", "research", "Brain Camp"

  supervisingDiplomateName  String?  // REQUIRED per ACVIM but nullable for pre-generation

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([residencyYear, monthNumber, weekNumber])
  @@index([residencyYear])
  @@index([monthNumber])
}
